# Cross-platform and multi-configuration build of the Methane Asteroids sample

name: "Asteroids Build"

on:
  push:
    branches: [ main, develop ]
    paths:
    - '.github/**/*.yml'
    - 'Apps/**'
    - 'Modules/**'
    - 'Externals/**'
    - 'CMakeLists.txt'
  pull_request:
    branches: [ main ]
    paths:
    - '.github/**/*.yml'
    - 'Apps/**'
    - 'Modules/**'
    - 'Externals/**'
    - 'CMakeLists.txt'
  schedule:
    - cron: '20 23 * * 3'

env:
  product_name: 'MethaneAsteroids'
  product_ver_major: 0
  product_ver_minor: 6
  product_ver_patch: 5
  product_ver_build: ${{ github.run_id }}
  product_ver_full:  ${{ product_ver_major }}.${{ product_ver_minor }}.${{ product_ver_patch }}.${{ product_ver_build }}

jobs:
  build-asteroids:
    name: Build ${{ matrix.name }} ${{ env.product_ver_full }}

    strategy:
      fail-fast: false
      matrix:
        include:
          - os: windows-2019
            name: "Win64_DX_Release"
            config_preset: "VS2019-Win64-DX-Default"
            build_preset: "VS2019-Win64-DX-Release"
          - os: windows-latest
            name: "Win64_VK_Release"
            config_preset: "VS2019-Win64-VK-Default"
            build_preset: "VS2019-Win64-VK-Release"
          - os: windows-latest
            name: "Win64_DX_Profile"
            config_preset: "VS2019-Win64-DX-Profile"
            build_preset: "VS2019-Win64-DX-Profile"
          - os: windows-latest
            name: "Win64_VK_Profile"
            config_preset: "VS2019-Win64-VK-Profile"
            build_preset: "VS2019-Win64-VK-Profile"
          - os: ubuntu-latest
            name: "Ubuntu_VK_Release"
            config_preset: "Make-Lin-VK-Release"
            build_preset: "Make-Lin-VK-Release"
          - os: ubuntu-latest
            name: "Ubuntu_VK_Profile"
            config_preset: "Make-Lin-VK-Profile"
            build_preset: "Make-Lin-VK-Profile"
          - os: macos-latest
            name: "MacOS_MTL_Release"
            config_preset: "Xcode-Mac-MTL-Default"
            build_preset: "Xcode-Mac-MTL-Release"
          - os: macos-latest
            name: "MacOS_MTL_Profile"
            config_preset: "Xcode-Mac-MTL-Profile"
            build_preset: "Xcode-Mac-MTL-Profile"

    runs-on: ${{ matrix.os }}

    env:
      name: ${{ env.product_name }}_${{ matrix.name }}_${{ env.product_ver_full }}

    steps:

    - name: Install Linux prerequisites
      if: ${{ matrix.os == 'ubuntu-latest' }}
      run: sudo apt install xcb libx11-dev libx11-xcb-dev libxcb-randr0-dev

    - name: Checkout repository
      uses: actions/checkout@v2

    - name: Initialize Externals Cache
      id: cache-externals
      uses: actions/cache@v3
      env:
        cache-name: cache-externals
      with:
        path: Build/Output/ExternalsCache
        key: ExternalsCache-${{ matrix.config_preset }}-${{ hashFiles('Externals/*.cmake') }}

    - name: CMake Configure Preset ${{ matrix.config_preset }}
      run: cmake --preset ${{ matrix.config_preset }} -DMETHANE_SHADERS_VALIDATION_ENABLED:BOOL=OFF

    - name: CMake Build Preset ${{ matrix.build_preset }}
      run: cmake --build --preset ${{ matrix.build_preset }} --parallel 4

    - name: Tar Installation Files
      if: ${{ matrix.os == 'ubuntu-latest' || matrix.os == 'macos-latest' }}
      run: tar -cvf ''Build/Output/${{ env.name }}.tar' 'Build/Output/${{ matrix.config_preset }}/Install'

    - name: Upload Unix Build Artifacts
      if: ${{ matrix.os == 'ubuntu-latest' || matrix.os == 'macos-latest' }}
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.name }}
        path: Build/Output/${{ env.name }}.tar

    - name: Upload Windows Build Artifacts
      if: ${{ matrix.os == 'windows-2019' }}
      uses: actions/upload-artifact@v3
      with:
        name: ${{ env.name }}
        path: Build/Output/${{ matrix.config_preset }}/Install
